<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Podcast Teaser Generator</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body>
  <header>
    <h1>Podcast Teaser Generator</h1>
    <p class="tagline">Create short, catchy teaser media from your script or prompt.</p>
  </header>
  <main>
    <section class="panel">
      <form id="genForm">
        <div class="grid">
          <label>Title
            <input name="title" value="{{ defaults.title }}" required />
          </label>
          <label>Headline
            <input name="headline" value="{{ defaults.headline }}" />
          </label>
          <label>Duration (s)
            <input type="number" name="duration" value="{{ defaults.duration }}" min="5" max="120" />
          </label>
          <label>Voice Name
            <select name="voice_name">
              {% set v = defaults.voice_name %}
              <option value="en-US-JennyNeural" {% if v=='en-US-JennyNeural' %}selected{% endif %}>en-US-JennyNeural (EN Female)</option>
              <option value="en-US-GuyNeural" {% if v=='en-US-GuyNeural' %}selected{% endif %}>en-US-GuyNeural (EN Male)</option>
              <option value="en-US-SaraNeural" {% if v=='en-US-SaraNeural' %}selected{% endif %}>en-US-SaraNeural (EN Female)</option>
              <option value="he-IL-HilaNeural" {% if v=='he-IL-HilaNeural' %}selected{% endif %}>he-IL-HilaNeural (HE Female)</option>
              <option value="he-IL-AvriNeural" {% if v=='he-IL-AvriNeural' %}selected{% endif %}>he-IL-AvriNeural (HE Male)</option>
            </select>
          </label>
        </div>
  <fieldset class="template-group">
          <legend>Teaser Template Fields</legend>
          <div class="grid two-col">
            <label>Song Title
              <input name="song_title" value="{{ defaults.song_title }}" />
            </label>
            <label>Artist
              <input name="artist" value="{{ defaults.artist }}" />
            </label>
            <label>Surprising Insight
              <textarea name="surprising_insight" rows="2">{{ defaults.surprising_insight }}</textarea>
            </label>
            <label>Emotional Angle
              <textarea name="emotional_angle" rows="2">{{ defaults.emotional_angle }}</textarea>
            </label>
            <label>Curiosity Hook Question
              <textarea name="curiosity_hook" rows="2">{{ defaults.curiosity_hook }}</textarea>
            </label>
            <label>Tone
              <input name="tone_field" value="{{ defaults.tone_field }}" />
            </label>
            <label>Audience
              <textarea name="audience_field" rows="2">{{ defaults.audience_field }}</textarea>
            </label>
            <label>Output Style
              <input name="output_desc" value="{{ defaults.output_desc }}" />
            </label>
          </div>
          <div class="xml-preview-wrapper">
            <label>Generated XML Prompt (auto-updates)
              <textarea name="prompt" rows="14" class="mono xml-preview" id="rawPrompt" readonly>{{ defaults.prompt }}</textarea>
            </label>
          </div>
        </fieldset>
        <!-- Removed separate Script field; XML prompt now primary source -->
        <div class="actions">
          <button type="button" data-mode="audio" class="primary">Generate Audio Only</button>
          <button type="button" data-mode="full" class="secondary">Generate Audio + Video</button>
        </div>
      </form>
    </section>
    <section class="panel" id="results" hidden>
      <h2>Result</h2>
      <div id="status" class="status">Working...</div>
      <div class="outputs" hidden>
        <p><strong>Project ID:</strong> <span id="pid"></span></p>
        <p><strong>Audio:</strong> <a id="audioLink" target="_blank">Open</a></p>
        <p><strong>Video:</strong> <a id="videoLink" target="_blank">Open</a></p>
        <p><strong>Final:</strong> <a id="finalLink" target="_blank">Open</a></p>
      </div>
    </section>
  </main>
  <footer>
    <p>CLI still available: <code>podcast-teaser ...</code></p>
  </footer>
  <script>
    const form = document.getElementById('genForm');
    const resultSection = document.getElementById('results');
    const statusEl = document.getElementById('status');
    const outputs = document.querySelector('.outputs');
    const pidEl = document.getElementById('pid');
    const audioLink = document.getElementById('audioLink');
    const videoLink = document.getElementById('videoLink');
    const finalLink = document.getElementById('finalLink');

    function buildXmlPrompt(fd){
      const duration = fd.get('duration') || '15';
      const baseOutput = (fd.get('output_desc')||'').replace('${DURATION}', duration);
      const xml = `\n<TeaserTemplate>\n  <Episode>\n    <SongTitle>${fd.get('song_title')||''}</SongTitle>\n    <Artist>${fd.get('artist')||''}</Artist>\n  </Episode>\n\n  <Content>\n    <SurprisingInsight>\n      ${fd.get('surprising_insight')||''}\n    </SurprisingInsight>\n\n    <EmotionalAngle>\n      ${fd.get('emotional_angle')||''}\n    </EmotionalAngle>\n\n    <CuriosityHook>\n      ${fd.get('curiosity_hook')||''}\n    </CuriosityHook>\n  </Content>\n\n  <Tone>\n    ${fd.get('tone_field')||''}\n  </Tone>\n\n  <Audience>\n    ${fd.get('audience_field')||''}\n  </Audience>\n\n  <Output>\n    ${baseOutput}\n  </Output>\n</TeaserTemplate>`;
      return xml.trim();
    }

    function formData(mode){
      const fd = new FormData(form);
      // Rebuild prompt from structured fields unless user manually edited rawPrompt after expanding
      const raw = document.getElementById('rawPrompt');
      const userEdited = raw && raw.dataset.edited === 'true';
      const prompt = userEdited ? raw.value : buildXmlPrompt(fd);
      if(raw && !userEdited){ raw.value = prompt; }
      const entries = [...fd.entries()].filter(([k]) => !['surprising_insight','emotional_angle','curiosity_hook','song_title','artist','tone_field','audience_field','output_desc'].includes(k));
      return Object.fromEntries([...entries, ['prompt', prompt], ['mode', mode]]);
    }

    const rawPrompt = document.getElementById('rawPrompt');
    function refreshXml(){
      const fd = new FormData(form);
      const xml = buildXmlPrompt(fd);
      if(rawPrompt) rawPrompt.value = xml;
    }
    // Update XML preview on input changes
    form.querySelectorAll('input,textarea,select').forEach(el => {
      if(el.name === 'prompt') return; // skip preview itself
      el.addEventListener('input', refreshXml);
      el.addEventListener('change', refreshXml);
    });
    refreshXml();

    async function trigger(mode){
      resultSection.hidden = false;
      outputs.hidden = true;
      statusEl.textContent = 'Submitting...';
      const payload = formData(mode);
      // Clear mutually exclusive prompt/script if both filled
      if(payload.prompt && payload.script){
        // prefer script if both present
        payload.prompt = '';
      }
      const res = await fetch('/api/generate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      const data = await res.json();
      if(data.project_id){
        statusEl.textContent = 'Completed';
        outputs.hidden = false;
        pidEl.textContent = data.project_id;
        audioLink.href = '/' + data.audio_path;
        if(data.video_path) videoLink.href = '/' + data.video_path; else videoLink.removeAttribute('href');
        if(data.final_path) finalLink.href = '/' + data.final_path; else finalLink.removeAttribute('href');
      } else {
        statusEl.textContent = 'Error generating';
      }
    }

    document.querySelectorAll('button[data-mode]').forEach(btn => {
      btn.addEventListener('click', () => trigger(btn.dataset.mode));
    });
  </script>
</body>
</html>
