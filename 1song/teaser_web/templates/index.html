<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Podcast Teaser Generator</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body>
  <header>
    <h1>Podcast Teaser Generator</h1>
    <p class="tagline">Create short, catchy teaser media from your script or prompt.</p>
  </header>
  <main>
    <section class="panel">
      <form id="genForm">
        <div class="grid">
          <label>Title
            <input name="title" value="{{ defaults.title }}" required />
          </label>
          <label>Headline
            <input name="headline" value="{{ defaults.headline }}" />
          </label>
          <label>Duration (s)
            <input type="number" name="duration" value="{{ defaults.duration }}" min="5" max="120" />
          </label>
          <label>Voice Name
            <select name="voice_name">
              {% set v = defaults.voice_name %}
              <option value="en-US-JennyNeural" {% if v=='en-US-JennyNeural' %}selected{% endif %}>en-US-JennyNeural (EN Female)</option>
              <option value="en-US-GuyNeural" {% if v=='en-US-GuyNeural' %}selected{% endif %}>en-US-GuyNeural (EN Male)</option>
              <option value="en-US-SaraNeural" {% if v=='en-US-SaraNeural' %}selected{% endif %}>en-US-SaraNeural (EN Female)</option>
              <option value="he-IL-HilaNeural" {% if v=='he-IL-HilaNeural' %}selected{% endif %}>he-IL-HilaNeural (HE Female)</option>
              <option value="he-IL-AvriNeural" {% if v=='he-IL-AvriNeural' %}selected{% endif %}>he-IL-AvriNeural (HE Male)</option>
            </select>
          </label>
        </div>
  <fieldset class="template-group">
          <legend>Teaser Template Fields</legend>
          <div class="grid two-col">
            <label>Song Title
              <input name="song_title" value="{{ defaults.song_title }}" />
            </label>
            <label>Artist
              <input name="artist" value="{{ defaults.artist }}" />
            </label>
            <label>Surprising Insight
              <textarea name="surprising_insight" rows="2">{{ defaults.surprising_insight }}</textarea>
            </label>
            <label>Emotional Angle
              <textarea name="emotional_angle" rows="2">{{ defaults.emotional_angle }}</textarea>
            </label>
            <label>Curiosity Hook Question
              <textarea name="curiosity_hook" rows="2">{{ defaults.curiosity_hook }}</textarea>
            </label>
            <label>Tone
              <input name="tone_field" value="{{ defaults.tone_field }}" />
            </label>
            <label>Audience
              <textarea name="audience_field" rows="2">{{ defaults.audience_field }}</textarea>
            </label>
            <label>Output Style
              <input name="output_desc" value="{{ defaults.output_desc }}" />
            </label>
          </div>
          <div class="xml-preview-wrapper">
            <label>Generated XML Prompt (auto-updates)
              <textarea name="prompt" rows="14" class="mono xml-preview" id="rawPrompt" readonly>{{ defaults.prompt }}</textarea>
            </label>
          </div>
        </fieldset>
        <!-- Removed separate Script field; XML prompt now primary source -->
        <div class="actions">
          <button type="button" data-mode="audio" class="primary">Generate Audio Only</button>
          <button type="button" data-mode="full" class="secondary">Generate Audio + Video</button>
        </div>
      </form>
    </section>
    <section class="panel" id="results" hidden>
      <h2>Result</h2>
      <div id="status" class="status">Working...</div>
      <div class="outputs" hidden>
        <p><strong>Project ID:</strong> <span id="pid"></span></p>
        <div class="media-block">
          <h3>Audio</h3>
          <audio id="audioPlayer" controls preload="metadata"></audio>
          <p><a id="audioLink" target="_blank">Open file</a></p>
        </div>
        <div class="media-block" id="videoBlock" hidden>
          <h3>Video (Raw)</h3>
          <video id="videoPlayer" controls playsinline preload="metadata" style="max-width:280px; width:100%; aspect-ratio:9/16; background:#000"></video>
          <p><a id="videoLink" target="_blank">Open file</a></p>
        </div>
        <div class="media-block" id="finalBlock" hidden>
          <h3>Final Composited</h3>
            <video id="finalPlayer" controls playsinline preload="metadata" style="max-width:280px; width:100%; aspect-ratio:9/16; background:#000"></video>
            <p><a id="finalLink" target="_blank">Open file</a></p>
        </div>
      </div>
    </section>
  </main>
  <footer>
    <p>CLI still available: <code>podcast-teaser ...</code></p>
  </footer>
  <script>
    const form = document.getElementById('genForm');
    const resultSection = document.getElementById('results');
    const statusEl = document.getElementById('status');
    const outputs = document.querySelector('.outputs');
    const pidEl = document.getElementById('pid');
  const audioLink = document.getElementById('audioLink');
  const videoLink = document.getElementById('videoLink');
  const finalLink = document.getElementById('finalLink');
  const audioPlayer = document.getElementById('audioPlayer');
  const videoPlayer = document.getElementById('videoPlayer');
  const finalPlayer = document.getElementById('finalPlayer');
  const videoBlock = document.getElementById('videoBlock');
  const finalBlock = document.getElementById('finalBlock');

    function buildXmlPrompt(fd){
      const duration = fd.get('duration') || '15';
      const baseOutput = (fd.get('output_desc')||'').replace('${DURATION}', duration);
      const xml = `\n<TeaserTemplate>\n  <Episode>\n    <SongTitle>${fd.get('song_title')||''}</SongTitle>\n    <Artist>${fd.get('artist')||''}</Artist>\n  </Episode>\n\n  <Content>\n    <SurprisingInsight>\n      ${fd.get('surprising_insight')||''}\n    </SurprisingInsight>\n\n    <EmotionalAngle>\n      ${fd.get('emotional_angle')||''}\n    </EmotionalAngle>\n\n    <CuriosityHook>\n      ${fd.get('curiosity_hook')||''}\n    </CuriosityHook>\n  </Content>\n\n  <Tone>\n    ${fd.get('tone_field')||''}\n  </Tone>\n\n  <Audience>\n    ${fd.get('audience_field')||''}\n  </Audience>\n\n  <Output>\n    ${baseOutput}\n  </Output>\n</TeaserTemplate>`;
      return xml.trim();
    }

    function formData(mode){
      const fd = new FormData(form);
      // Rebuild prompt from structured fields unless user manually edited rawPrompt after expanding
      const raw = document.getElementById('rawPrompt');
      const userEdited = raw && raw.dataset.edited === 'true';
      const prompt = userEdited ? raw.value : buildXmlPrompt(fd);
      if(raw && !userEdited){ raw.value = prompt; }
      const entries = [...fd.entries()].filter(([k]) => !['surprising_insight','emotional_angle','curiosity_hook','song_title','artist','tone_field','audience_field','output_desc'].includes(k));
      return Object.fromEntries([...entries, ['prompt', prompt], ['mode', mode]]);
    }

    const rawPrompt = document.getElementById('rawPrompt');
    function refreshXml(){
      const fd = new FormData(form);
      const xml = buildXmlPrompt(fd);
      if(rawPrompt) rawPrompt.value = xml;
    }
    // Update XML preview on input changes
    form.querySelectorAll('input,textarea,select').forEach(el => {
      if(el.name === 'prompt') return; // skip preview itself
      el.addEventListener('input', refreshXml);
      el.addEventListener('change', refreshXml);
    });
    refreshXml();

    async function trigger(mode){
      resultSection.hidden = false;
      outputs.hidden = true;
      statusEl.textContent = 'Submitting...';
      const payload = formData(mode);
      // Clear mutually exclusive prompt/script if both filled
      if(payload.prompt && payload.script){
        // prefer script if both present
        payload.prompt = '';
      }
      const res = await fetch('/api/generate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      const data = await res.json();
      if(!data.project_id){
        statusEl.textContent = 'Error generating';
        return;
      }
      pidEl.textContent = data.project_id;
      const projectId = data.project_id;
      // Always set audio if present
      if(data.audio_url){
        const bust = data.audio_url + '?v=' + Date.now();
        audioLink.href = bust;
        audioPlayer.src = bust;
      } else if(data.audio_path){
        const legacy = '/' + data.audio_path;
        audioLink.href = legacy;
        audioPlayer.src = legacy;
      }
      outputs.hidden = false;
      if(mode === 'audio'){
        statusEl.textContent = 'Audio ready';
        return;
      }
      statusEl.textContent = 'Processing video...';
      // Poll status endpoint
      const poll = async () => {
        try {
          const r = await fetch(`/api/status?project_id=${projectId}`);
          const s = await r.json();
          if(s.audio_url){
            const bustA = s.audio_url + '?v=' + Date.now();
            audioLink.href = bustA; audioPlayer.src = audioPlayer.src || bustA;
          }
          if(s.video_url){
            const bustV = s.video_url + '?v=' + Date.now();
            videoLink.href = bustV;
            if(!videoPlayer.src) videoPlayer.src = bustV;
            videoBlock.hidden = false;
          }
          if(s.final_url){
            const bustF = s.final_url + '?v=' + Date.now();
            finalLink.href = bustF;
            if(!finalPlayer.src) finalPlayer.src = bustF;
            finalBlock.hidden = false;
          }
          if(s.status === 'completed'){
            statusEl.textContent = 'Completed';
            return; // stop polling
          } else if(s.status === 'video_ready') {
            statusEl.textContent = 'Video ready, composing...';
          } else if(s.status === 'audio_ready') {
            statusEl.textContent = 'Audio ready, generating video...';
          } else {
            statusEl.textContent = 'Processing...';
          }
        } catch(e){
          statusEl.textContent = 'Polling error; retrying...';
        }
        setTimeout(poll, 3000);
      };
      poll();
    }

    document.querySelectorAll('button[data-mode]').forEach(btn => {
      btn.addEventListener('click', () => trigger(btn.dataset.mode));
    });
  </script>
</body>
</html>
